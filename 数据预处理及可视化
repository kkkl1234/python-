import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import warnings
import os
from typing import List, Tuple, Dict

# -------------------------- 1. å…¨å±€é…ç½®--------------------------
# å­—ä½“ä¸æ˜¾ç¤ºé…ç½®ï¼ˆè§£å†³ä¸­æ–‡ä¹±ç ï¼‰
plt.rcParams['font.sans-serif'] = ['Hiragino Sans GB', 'STHeiti', 'Arial']
plt.rcParams['axes.unicode_minus'] = False
warnings.filterwarnings('ignore', category=UserWarning, module='matplotlib')
warnings.filterwarnings('ignore', category=FutureWarning)

os.makedirs("visualization_results", exist_ok=True)

# å›ºå®šé…ç½®
POWER_CONFIGS = [
    ("Zone 1 Power Consumption", "åŒºåŸŸ1ç”µåŠ›æ¶ˆè€— (kW)", "#45B7D1"),
    ("Zone 2  Power Consumption", "åŒºåŸŸ2ç”µåŠ›æ¶ˆè€— (kW)", "#45B7D1"),  # åˆ—åå«2ä¸ªç©ºæ ¼
    ("Zone 3  Power Consumption", "åŒºåŸŸ3ç”µåŠ›æ¶ˆè€— (kW)", "#45B7D1")   # åˆ—åå«2ä¸ªç©ºæ ¼
]
FEATURE_COLS = [
    'Temperature', 'Humidity', 'Wind Speed', 
    'general diffuse flows', 'diffuse flows'
]
UNIT_MAP = {
    'Temperature': 'Â°C',
    'Humidity': '%',
    'Wind Speed': 'm/s',
    'general diffuse flows': 'W/mÂ²',
    'diffuse flows': 'W/mÂ²'
}

# -------------------------- 2. ç±»å®šä¹‰ --------------------------
class PowerConsumptionAnalyzer:
    def __init__(self, data_path: str = "consumption.csv"):
        self.data_path = data_path
        self.df_raw = None  # åŸå§‹æ•°æ®
        self.df_processed = None  # æ—¥æœŸç´¢å¼•å¤„ç†åçš„æ•°æ®
        self.df_daily_mean = None  # æ—¥å‡å€¼æ•°æ®
        self.feature_data = None  # ç‰¹å¾æ•°æ®ï¼ˆç”¨äºåç»­ç®—æ³•ï¼‰

    def load_data(self) -> None:
        try:
            # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
            if not os.path.exists(self.data_path):
                raise FileNotFoundError(f"æ•°æ®æ–‡ä»¶ä¸å­˜åœ¨ï¼š{self.data_path}")
            
            # è¯»å–æ•°æ®
            self.df_raw = pd.read_csv(self.data_path)
            print(f"âœ… æˆåŠŸåŠ è½½åŸå§‹æ•°æ®ï¼Œå½¢çŠ¶ï¼š{self.df_raw.shape}")
            
            # æ£€æŸ¥å¿…è¦åˆ—æ˜¯å¦å­˜åœ¨
            required_cols = ["DateTime"] + [cfg[0] for cfg in POWER_CONFIGS] + FEATURE_COLS
            missing_cols = [col for col in required_cols if col not in self.df_raw.columns]
            if missing_cols:
                raise ValueError(f"æ•°æ®ç¼ºå¤±å¿…è¦åˆ—ï¼š{missing_cols}")
        
        except Exception as e:
            raise RuntimeError(f"âŒ æ•°æ®åŠ è½½å¤±è´¥ï¼š{str(e)}")

    def process_data(self) -> None:
        if self.df_raw is None:
            raise ValueError("è¯·å…ˆè°ƒç”¨ load_data() åŠ è½½æ•°æ®")
        
        try:
            # æ—¥æœŸè½¬æ¢ä¸ç´¢å¼•è®¾ç½®
            self.df_processed = self.df_raw.copy()
            self.df_processed["DateTime"] = pd.to_datetime(self.df_processed["DateTime"], errors='coerce')
            
            # æ£€æŸ¥æ—¥æœŸè½¬æ¢æœ‰æ•ˆæ€§
            invalid_date_count = self.df_processed["DateTime"].isnull().sum()
            if invalid_date_count > 0:
                raise ValueError(f"æ—¥æœŸè½¬æ¢å¤±è´¥ï¼Œå…±{invalid_date_count}æ¡æ— æ•ˆæ—¥æœŸæ•°æ®")
            
            self.df_processed.set_index("DateTime", inplace=True)
            
            # æ—¥å‡å€¼é‡é‡‡æ ·
            self.df_daily_mean = self.df_processed.resample('D').mean()
            
            # æ£€æŸ¥é‡é‡‡æ ·åæ•°æ®æœ‰æ•ˆæ€§
            if self.df_daily_mean.empty:
                raise ValueError("æ—¥å‡å€¼é‡é‡‡æ ·åæ•°æ®ä¸ºç©ºï¼Œè¯·æ£€æŸ¥åŸå§‹æ•°æ®æ—¶é—´èŒƒå›´")
            
            # å¤„ç†ç‰¹å¾åˆ—ç¼ºå¤±å€¼ï¼ˆç”¨æˆ·æŒ‡å®šé€»è¾‘ï¼‰
            self.feature_data = self.df_daily_mean[FEATURE_COLS].fillna(method='ffill').fillna(method='bfill')
            
            print(f"âœ… æ•°æ®é¢„å¤„ç†å®Œæˆ")
            print(f"  - å¤„ç†åæ•°æ®å½¢çŠ¶ï¼š{self.df_processed.shape}")
            print(f"  - æ—¥å‡å€¼æ•°æ®å½¢çŠ¶ï¼š{self.df_daily_mean.shape}")
            print(f"  - ç‰¹å¾æ•°æ®å½¢çŠ¶ï¼š{self.feature_data.shape}")
        
        except Exception as e:
            raise RuntimeError(f"âŒ æ•°æ®é¢„å¤„ç†å¤±è´¥ï¼š{str(e)}")

    def plot_power_time_series(self) -> None:
        """ç»˜åˆ¶3ä¸ªåŒºåŸŸç”µåŠ›æ¶ˆè€—æ—¥å‡å€¼æ—¶åºå›¾"""
        if self.df_daily_mean is None:
            raise ValueError("è¯·å…ˆè°ƒç”¨ process_data() å¤„ç†æ•°æ®")
        
        # åˆ›å»º3è¡Œ1åˆ—å­å›¾
        fig, axes = plt.subplots(nrows=3, ncols=1, figsize=(14, 12), sharex=True)
        
        # éå†æ¯ä¸ªåŒºåŸŸç»˜åˆ¶
        for idx, (col_name, chinese_name, color) in enumerate(POWER_CONFIGS):
            ax = axes[idx]
            # ç»˜åˆ¶æ—¶åºæ›²çº¿ï¼ˆå«åœ†ç‚¹ä¼˜åŒ–ï¼‰
            ax.plot(
                self.df_daily_mean.index, self.df_daily_mean[col_name],
                color=color, linewidth=2.5, alpha=0.9,
                markersize=5, markerfacecolor='white', markeredgewidth=1.5
            )
            
            # å›¾è¡¨æ ·å¼é…ç½®
            ax.set_title(f"{chinese_name}ï¼ˆæ—¥å‡å€¼æ—¶é—´åºåˆ—ï¼‰", fontsize=15, fontweight="bold", pad=15)
            ax.set_ylabel(chinese_name.split(" ")[-1], fontsize=11, fontweight="medium")
            ax.tick_params(axis='y', labelsize=10)
            ax.grid(True, alpha=0.3, linestyle='--')
            
            # è°ƒæ•´yè½´èŒƒå›´ï¼ˆä¸Šä¸‹ç•™ç©º5%ï¼‰
            y_min = self.df_daily_mean[col_name].min() * 0.95
            y_max = self.df_daily_mean[col_name].max() * 1.05
            ax.set_ylim(y_min, y_max)
            
            # æœ€åä¸€ä¸ªå­å›¾æ˜¾ç¤ºxè½´æ ‡ç­¾
            if idx == 2:
                ax.set_xlabel("æ—¥æœŸ", fontsize=12, fontweight="medium")
                ax.tick_params(axis='x', rotation=45, labelsize=10)
        
        # è°ƒæ•´xè½´èŒƒå›´
        x_min = self.df_daily_mean.index.min() - pd.Timedelta(days=1)
        x_max = self.df_daily_mean.index.max() + pd.Timedelta(days=1)
        for ax in axes:
            ax.set_xlim(x_min, x_max)
        
        # è°ƒæ•´å­å›¾é—´è·
        plt.tight_layout(pad=3.0)
        plt.savefig("visualization_results/power_daily_mean_series.png", dpi=300, bbox_inches='tight')
        plt.show()
        print("âœ… ç”µåŠ›æ¶ˆè€—æ—¶åºå›¾å·²ä¿å­˜è‡³ visualization_results/")

    def plot_feature_time_series(self) -> None:
        """ç»˜åˆ¶5ä¸ªç¯å¢ƒç‰¹å¾æ—¶åºå›¾"""
        if self.feature_data is None:
            raise ValueError("è¯·å…ˆè°ƒç”¨ process_data() å¤„ç†æ•°æ®")
        
        # åˆ›å»º3è¡Œ2åˆ—å­å›¾
        fig, axes = plt.subplots(3, 2, figsize=(16, 10), sharex=True)
        fig.suptitle('ç¯å¢ƒç‰¹å¾æ—¶åºå˜åŒ–è¶‹åŠ¿', fontsize=18, fontweight='bold', y=0.98)
        
        # å­å›¾ä½ç½®æ˜ å°„ï¼ˆ5ä¸ªç‰¹å¾å¯¹åº”å‰5ä¸ªä½ç½®ï¼‰
        subplot_pos = [(0,0), (0,1), (1,0), (1,1), (2,0)]
        
        # é€ä¸ªç»˜åˆ¶ç‰¹å¾
        for idx, (feat, pos) in enumerate(zip(FEATURE_COLS, subplot_pos)):
            ax = axes[pos]
            # ç»˜åˆ¶æ—¶åºæ›²çº¿ï¼ˆé»˜è®¤é¢œè‰²ï¼‰
            ax.plot(
                self.feature_data.index, self.feature_data[feat],
                linewidth=1.8, alpha=0.8, label=feat
            )
            # æ·»åŠ å‡å€¼çº¿
            mean_val = self.feature_data[feat].mean()
            ax.axhline(
                y=mean_val, color='black', linestyle='--', linewidth=1.2, alpha=0.7,
                label=f'å‡å€¼ï¼š{mean_val:.2f} {UNIT_MAP.get(feat, "")}'
            )
            
            # æ ·å¼é…ç½®
            ax.set_title(feat, fontsize=12, fontweight='medium', pad=8)
            ax.set_ylabel(f'æ•°å€¼ï¼ˆ{UNIT_MAP.get(feat, "æ— å•ä½")}ï¼‰', fontsize=10)
            ax.grid(True, linestyle='--', alpha=0.3)
            ax.legend(loc='upper right', fontsize=9, framealpha=0.9)
            ax.tick_params(axis='y', labelsize=9)
        
        # éšè—æœ€åä¸€ä¸ªç©ºå­å›¾
        axes[2, 1].axis('off')
        
        # é…ç½®xè½´æ ‡ç­¾
        axes[2, 0].set_xlabel('æ—¶é—´', fontsize=12, fontweight='medium')
        axes[2, 0].tick_params(axis='x', rotation=45, labelsize=9)
        
        # è°ƒæ•´é—´è·ï¼ˆé¢„ç•™æ ‡é¢˜ç©ºé—´ï¼‰
        plt.tight_layout(rect=[0, 0, 1, 0.96])
        # ä¿å­˜å›¾ç‰‡
        plt.savefig("visualization_results/feature_time_series.png", dpi=300, bbox_inches='tight')
        plt.show()
        print("âœ… ç‰¹å¾æ—¶åºå›¾å·²ä¿å­˜è‡³ visualization_results/")

    def get_processed_data(self) -> Tuple[pd.DataFrame, pd.DataFrame]:
        """è·å–å¤„ç†åçš„æ•°æ®"""
        if self.df_daily_mean is None or self.feature_data is None:
            raise ValueError("è¯·å…ˆè°ƒç”¨ process_data() å¤„ç†æ•°æ®")
        return self.df_daily_mean, self.feature_data

# -------------------------- 3. è¾…åŠ©å‡½æ•°ï¼ˆæ»¡è¶³å‡½æ•°è°ƒç”¨è¦æ±‚ï¼‰ --------------------------
def validate_data_quality(df: pd.DataFrame, data_name: str) -> bool:
    """éªŒè¯æ•°æ®è´¨é‡ï¼ˆç‹¬ç«‹å‡½æ•°ï¼Œä½“ç°å‡½æ•°è°ƒç”¨ï¼‰"""
    # æ£€æŸ¥æ•°æ®éç©º
    if df.empty:
        print(f"âŒ {data_name} æ•°æ®ä¸ºç©º")
        return False
    # æ£€æŸ¥ç‰¹å¾åˆ—ç¼ºå¤±å€¼
    missing_ratio = df[FEATURE_COLS].isnull().sum() / len(df) * 100
    high_missing_cols = missing_ratio[missing_ratio > 30].index.tolist()
    if high_missing_cols:
        print(f"âš ï¸ {data_name} ä»¥ä¸‹ç‰¹å¾ç¼ºå¤±ç‡è¶…è¿‡30%ï¼š{high_missing_cols}")
    return True

# -------------------------- 4. ä¸»å‡½æ•° --------------------------
def main():
    
    try:
        # 1. åˆå§‹åŒ–åˆ†æå™¨
        analyzer = PowerConsumptionAnalyzer(data_path="consumption.csv")
        
        # 2. åŠ è½½æ•°æ®
        analyzer.load_data()
        
        # 3. æ•°æ®é¢„å¤„ç†
        analyzer.process_data()
        
        # 4. éªŒè¯æ•°æ®è´¨é‡
        df_daily_mean, feature_data = analyzer.get_processed_data()
        if validate_data_quality(df_daily_mean, "æ—¥å‡å€¼æ•°æ®") and validate_data_quality(feature_data, "ç‰¹å¾æ•°æ®"):
            print("âœ… æ•°æ®è´¨é‡éªŒè¯é€šè¿‡")
        
        # 5. ç»˜åˆ¶å¯è§†åŒ–å›¾è¡¨
        print("\nğŸ“Š å¼€å§‹ç»˜åˆ¶ç”µåŠ›æ¶ˆè€—æ—¶åºå›¾...")
        analyzer.plot_power_time_series()
        
        print("\nğŸ“Š å¼€å§‹ç»˜åˆ¶ç‰¹å¾æ—¶åºå›¾...")
        analyzer.plot_feature_time_series()
        
        print("\n" + "="*60)
        print("ğŸ‰ æ•°æ®é¢„å¤„ç†ä¸å¯è§†åŒ–æµç¨‹å®Œæˆï¼")
        print("="*60)
        print("è¾“å‡ºæ–‡ä»¶æ¸…å•ï¼š")
        print("1. ç”µåŠ›æ¶ˆè€—æ—¶åºå›¾ï¼švisualization_results/power_daily_mean_series.png")
        print("2. ç‰¹å¾æ—¶åºå›¾ï¼švisualization_results/feature_time_series.png")
    
    except Exception as e:
        print(f"\nâŒ æµç¨‹æ‰§è¡Œå¤±è´¥ï¼š{str(e)}")
        raise

if __name__ == "__main__":
    main()
